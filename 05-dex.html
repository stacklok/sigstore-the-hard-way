<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dex (oauth2) - sigstore the hard way</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="How to deploy sigstore from the ground up.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="01-prerequisites.html"><strong aria-hidden="true">1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="02-compute-resources.html"><strong aria-hidden="true">2.</strong> Compute Resources</a></li><li class="chapter-item expanded "><a href="03-domain-configuration.html"><strong aria-hidden="true">3.</strong> Domain Configuration</a></li><li class="chapter-item expanded "><a href="04-rekor.html"><strong aria-hidden="true">4.</strong> rekor</a></li><li class="chapter-item expanded "><a href="05-dex.html" class="active"><strong aria-hidden="true">5.</strong> Dex (oauth2)</a></li><li class="chapter-item expanded "><a href="06-fulcio.html"><strong aria-hidden="true">6.</strong> Fulcio</a></li><li class="chapter-item expanded "><a href="07-certifcate-transparency.html"><strong aria-hidden="true">7.</strong> Certificate Transparency</a></li><li class="chapter-item expanded "><a href="08-configure-registry.html"><strong aria-hidden="true">8.</strong> Configure OCI Registry</a></li><li class="chapter-item expanded "><a href="09-cosign.html"><strong aria-hidden="true">9.</strong> Setup Cosign</a></li><li class="chapter-item expanded "><a href="10-sign-container.html"><strong aria-hidden="true">10.</strong> Sign a Container</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="misc/contributors.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">sigstore the hard way</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dex"><a class="header" href="#dex">Dex</a></h1>
<p>Dex is the solution used for handling OpenID connect sessions.</p>
<p>A user first connects to a dex instance where an OpenID session is invoked.</p>
<p>The user then authorises Fulcio to request the users email address as part of an
OpenID scope. This email address is then recored into the x509 signing
certificates.</p>
<p>Connect to the compute instance:</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-oauth2
</code></pre>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<pre><code class="language-bash">sudo apt-get install haproxy make git gcc certbot -y
</code></pre>
<h3 id="install-latest-golang-compiler"><a class="header" href="#install-latest-golang-compiler">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package is not yet 1.16)</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code>Welcome to the Go installer!
Downloading Go version go1.17.1 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile

go version
go version go1.17.1 linux/amd64
</code></pre>
<h3 id="lets-encrypt-tls--ha-proxy-config"><a class="header" href="#lets-encrypt-tls--ha-proxy-config">Let's encrypt (TLS) &amp; HA Proxy config</a></h3>
<p>Let's create a HAProxy config, set <code>DOMAIN</code> to your registered domain and your
private <code>IP</code> address:</p>
<pre><code class="language-bash">DOMAIN=&quot;oauth2.yourdomain.com&quot;
IP=&quot;10.240.0.12&quot;
</code></pre>
<p>Let's now run certbot to obtain our TLS certs:</p>
<pre><code class="language-bash">sudo certbot certonly --standalone --preferred-challenges http \
      --http-01-address ${IP} --http-01-port 80 -d ${DOMAIN} \
      --non-interactive --agree-tos --email youremail@domain.com
</code></pre>
<p>Move the PEM chain into place:</p>
<pre><code class="language-bash">sudo cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    | sudo tee &quot;/etc/ssl/private/${DOMAIN}.pem&quot; &gt; /dev/null
</code></pre>
<p>Now we need to change certbot configuration for automatic renewal.</p>
<p>Prepare post renewal script:</p>
<pre><code class="language-bash">cat /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
#!/bin/bash

DOMAIN=&quot;oauth2.example.com&quot;

cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    &gt; &quot;/etc/ssl/private/${DOMAIN}.pem&quot;

systemctl reload haproxy.service
</code></pre>
<p>Make sure the script has executable flag set:</p>
<pre><code class="language-bash">sudo chmod +x /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Replace port and address in the certbot's renewal configuration file for the domain (pass ACME request through the haproxy to certbot):</p>
<pre><code class="language-bash">ls -l /etc/letsencrypt/renewal/oauth2.example.com.conf
</code></pre>
<pre><code class="language-bash">http01_port = 9080
http01_address = 127.0.0.1
</code></pre>
<p>Append new line</p>
<pre><code class="language-bash">post_hook = /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Prepare haproxy configuration:</p>
<pre><code class="language-bash">cat &gt; haproxy.cfg &lt;&lt;EOF
defaults
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    log global
    mode http
    option httplog
    maxconn 3000
    log 127.0.0.1 local0

frontend haproxy
    #public IP address
    bind ${IP}:80
    bind ${IP}:443 ssl crt /etc/ssl/private/${DOMAIN}.pem

    # HTTPS redirect
    redirect scheme https code 301 if !{ ssl_fc }

    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend letsencrypt-backend if letsencrypt-acl

    default_backend sigstore_dex

backend sigstore_dex
    server sigstore_oauth2_internal ${IP}:6000

backend letsencrypt-backend
    server certbot_internal 127.0.0.1:9080
EOF
</code></pre>
<p>Inspect the resulting <code>haproxy.cfg</code> and make sure everything looks correct.</p>
<p>If so, move it into place:</p>
<pre><code class="language-bash">sudo mv haproxy.cfg /etc/haproxy/
</code></pre>
<p>Check syntax:</p>
<pre><code class="language-bash">sudo /usr/sbin/haproxy -c -V -f /etc/haproxy/haproxy.cfg
</code></pre>
<h3 id="start-haproxy"><a class="header" href="#start-haproxy">Start HAProxy</a></h3>
<p>Let's now start HAProxy:</p>
<pre><code class="language-bash">sudo systemctl enable haproxy.service

Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable haproxy
</code></pre>
<pre><code class="language-bash">sudo systemctl restart haproxy.service

sudo systemctl status haproxy.service
● haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/lib/systemd/system/haproxy.service; enabled; vendor preset: enabled)
   Active: active (running) since Sun 2021-07-18 10:12:28 UTC; 58min ago
     Docs: man:haproxy(1)
           file:/usr/share/doc/haproxy/configuration.txt.gz
 Main PID: 439 (haproxy)
    Tasks: 2 (limit: 2322)
   Memory: 4.1M
   CGroup: /system.slice/haproxy.service
           ├─439 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
           └─444 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid

Jul 18 10:12:27 sigstore-fulcio systemd[1]: Starting HAProxy Load Balancer...
Jul 18 10:12:28 sigstore-fulcio systemd[1]: Started HAProxy Load Balancer.
</code></pre>
<p>Test automatic renewal:</p>
<pre><code class="language-bash">sudo certbot renew --dry-run
</code></pre>
<h3 id="install-dex"><a class="header" href="#install-dex">Install Dex</a></h3>
<pre><code class="language-bash">mkdir -p ~/go/src/github.com/dexidp/ &amp;&amp; cd &quot;$_&quot;
git clone https://github.com/dexidp/dex.git
</code></pre>
<pre><code class="language-bash">cd dex
make build
sudo mv bin/dex /usr/local/bin/
</code></pre>
<h3 id="obtain-google-oauth-credentials"><a class="header" href="#obtain-google-oauth-credentials">Obtain Google OAUTH credentials</a></h3>
<blockquote>
<p>📝 We re using Google here, you can do the same for github and microsoft too.
The placeholders are already within <code>config.yaml</code></p>
</blockquote>
<ol>
<li>
<p>Head to the <a href="https://console.cloud.google.com/apis/credentials">credentials page</a></p>
</li>
<li>
<p>Select 'CONFIGURE CONSENT SCREEN'</p>
<p>Select 'Internal'</p>
<p><img src="images/oauth-consent.png" alt="consent" /></p>
<p>NOTE: If you're not a Google Workspace user, the 'Internal' option will not be available. You can only make your app available to external (general audience) users only. In such a case, the 'External' User Type works fine as well.</p>
<p>Fill out the app registration details</p>
<p><img src="images/app-reg.png" alt="consent" /></p>
</li>
<li>
<p>Set scopes</p>
<p>Select 'ADD OR REMOVE SCOPES' and set the <code>userinfo.email</code> scope</p>
<p><img src="images/scopes.png" alt="scopes" /></p>
<p>Select &quot;SAVE AND CONTINUE&quot;</p>
<p>Select &quot;BACK TO DASHBOARD&quot; and select 'Credentials'</p>
</li>
<li>
<p>Create OAuth Client ID</p>
<p><img src="images/oauth-credentials.png" alt="credentials" /></p>
<p>Select &quot;OAuth client ID&quot;. Select &quot;Web Application&quot; and fill out the &quot;Authorized Redirect URIs&quot;</p>
<p>Select &quot;CREATE&quot;</p>
<p><img src="images/oauth-redirect.png" alt="redirect-uri" /></p>
</li>
<li>
<p>Note down tour Client ID and Secret and keep them safe (we will need them for dex)</p>
</li>
</ol>
<h3 id="configure-dex"><a class="header" href="#configure-dex">Configure Dex</a></h3>
<p>Set up the configuration file for dex.</p>
<p>Provide saved OIDC details as variables:</p>
<pre><code class="language-bash">GOOGLE_CLIENT_ID=&quot;...&quot;
GOOGLE_CLIENT_SECRET=&quot;...&quot;
</code></pre>
<pre><code class="language-bash">cat &gt; dex-config.yaml &lt;&lt;EOF
issuer: https://${DOMAIN}/auth

storage:
  type: sqlite3
  config:
    file: /var/dex/dex.db
web:
  http: 0.0.0.0:5556
frontend:
  issuer: sigstore
  theme: light

# Configuration for telemetry
telemetry:
  http: 0.0.0.0:5558

# Options for controlling the logger.
logger:
  level: &quot;debug&quot;
  format: &quot;json&quot;

# Default values shown below
oauth2:
  responseTypes: [ &quot;code&quot; ]
  skipApprovalScreen: false
  alwaysShowLoginScreen: true

staticClients:
  - id: sigstore
    public: true
    name: 'sigstore'
redirectURI: https://${DOMAIN}/auth/callback

connectors:
- type: google
  id: google-sigstore-test
  name: Google
  config:
    clientID: $GOOGLE_CLIENT_ID
    clientSecret: $GOOGLE_CLIENT_SECRET
    redirectURI: https://${DOMAIN}/auth/callback

#- type: microsoft
#  id: microsoft-sigstore-test
#  name: Microsoft
#  config:
#     clientID: $MSFT_CLIENT_ID
#     clientSecret: $MSFT_CLIENT_SECRET
#     redirectURI: https://${DOMAIN}/auth/callback

#- type: github
#  id: github-sigstore-test
#  name: GitHub
#  config:
#     clientID: $GITHUB_CLIENT_ID
#     clientSecret: $GITHUB_CLIENT_SECRET
#     redirectURI: https://${DOMAIN}/auth/callback
EOF
</code></pre>
<p>Move configuration file:</p>
<pre><code class="language-bash">sudo mkdir -p /var/dex/
sudo mkdir -p /etc/dex/
sudo mv dex-config.yaml /etc/dex/
</code></pre>
<h3 id="start-dex"><a class="header" href="#start-dex">Start dex</a></h3>
<pre><code class="language-bash">dex serve --web-http-addr=0.0.0.0:6000  /etc/dex/dex-config.yaml
</code></pre>
<p>You may create a bare minimal systemd service for dex:</p>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt; EOF &gt; /etc/systemd/system/dex.service
[Unit]
Description=dex
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/dex serve --web-http-addr=0.0.0.0:6000 /etc/dex/dex-config.yaml
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable dex.service
sudo systemctl start dex.service
sudo systemctl status dex.service
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="04-rekor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="06-fulcio.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="04-rekor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="06-fulcio.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>

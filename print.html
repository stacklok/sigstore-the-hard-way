<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>sigstore the hard way</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="How to deploy sigstore from the ground up.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="01-prerequisites.html"><strong aria-hidden="true">1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="02-compute-resources.html"><strong aria-hidden="true">2.</strong> Compute Resources</a></li><li class="chapter-item expanded "><a href="03-domain-configuration.html"><strong aria-hidden="true">3.</strong> Domain Configuration</a></li><li class="chapter-item expanded "><a href="04-rekor.html"><strong aria-hidden="true">4.</strong> rekor</a></li><li class="chapter-item expanded "><a href="05-dex.html"><strong aria-hidden="true">5.</strong> Dex (oauth2)</a></li><li class="chapter-item expanded "><a href="06-fulcio.html"><strong aria-hidden="true">6.</strong> Fulcio</a></li><li class="chapter-item expanded "><a href="07-certifcate-transparency.html"><strong aria-hidden="true">7.</strong> Certificate Transparency</a></li><li class="chapter-item expanded "><a href="08-configure-registry.html"><strong aria-hidden="true">8.</strong> Configure OCI Registry</a></li><li class="chapter-item expanded "><a href="09-cosign.html"><strong aria-hidden="true">9.</strong> Setup Cosign</a></li><li class="chapter-item expanded "><a href="10-sign-container.html"><strong aria-hidden="true">10.</strong> Sign a Container</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="misc/contributors.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">sigstore the hard way</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sigstore-the-hard-way"><a class="header" href="#sigstore-the-hard-way">Sigstore the Hard Way</a></h1>
<p>Welcome to sigstore the hard way.</p>
<p>The driver for this project is to get potential users, developers or collaborators familiar with the inner workings of
sigstore's infrastructure.</p>
<p>To best achieve a good familiarity with sigstore, we will walk through the whole process manually.</p>
<p>Building &quot;by hand&quot; provides a view of how each component project in sigstore glues together, while deliberately avoiding automation.  This
means no Dockerfiles or deployment framework playbooks. Everything is set up manually.</p>
<p>With 'sigstore the hard way' we will install, configure and run the following components to provide a 'keyless' signing
infrastructure.</p>
<ol>
<li><a href="https://github.com/sigstore/fulcio">Fulcio</a> WebPKI</li>
<li><a href="https://github.com/sigstore/rekor">Rekor</a>, signature transparency log and timestamping authority</li>
<li><a href="https://github.com/google/certificate-transparency-go/tree/master/trillian">Certificate Transparency Log</a></li>
<li><a href="https://github.com/dexidp/dex">Dex</a>, OpenID Connect provider</li>
<li><a href="https://github.com/sigstore/cosign">Cosign</a>, container (and more) signing and verifying tool</li>
</ol>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>This tutorial leverages the <a href="https://cloud.google.com/">GCP</a> for the provisioning of the compute
infrastructure required to bootstrap the sigstore infra from the ground up.
Free credits are available on <a href="https://cloud.google.com/free/">Sign up</a>. For when it comes to saving costs, the recommendation
is to shutdown any instances when you're not using them and once you have completed the tutorial, delete
all the instances, networks etc.</p>
<p>You can of course use local machines if you have them, or any other provider such as AWS, Azure (pull requests welcomed!)</p>
<p>The only other requirement is a domain name, where you have the ability to create some subdomains. We need a domain
for an OpenID Connect session (providers don't always like redirect_urls to IP addresses). It's up to you who you use, any provider will do. If you already have a domain, it makes sense to use that. We won't be messing with the root domain if you're already running something there, just creating subdomains (e.g. rekor.example.com, fulcio.example.com)</p>
<h2 id="certificate-authority"><a class="header" href="#certificate-authority">Certificate Authority</a></h2>
<p>For the Certificate Authority we will have three options to choose from:</p>
<ul>
<li>File CA</li>
<li><a href="http://www.softhsm.org/">SoftHSM</a></li>
<li>Google's Certificate Transparency Service</li>
</ul>
<p>The above are listed in order of setup ease. If you just want to kick the tyres and don't need a secure CA, you can use the File CA.</p>
<p>Google's is a paid service, but easy to set up. SoftHSM is completely free, but requires a little more setup (but nothing
too challenging)</p>
<p>Last of all we will sign a container image using cosign.</p>
<h3 id="copyright"><a class="header" href="#copyright">Copyright</a></h3>
<p>If you have not guessed by name, this is based off, and comes with credit to <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kelsey Hightower's Kubernetes the Hard Way</a></p>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img ealt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>
<h2 id="having-issues-something-not-working"><a class="header" href="#having-issues-something-not-working">Having issues, something not working?</a></h2>
<p><a href="https://github.com/lukehinds/sigstore-the-hard-way/issues/new/choose">Raise an issue</a> (best option, as others can learn) or message me on the <a href="https://join.slack.com/t/sigstore/shared_invite/zt-mhs55zh0-XmY3bcfWn4XEyMqUUutbUQ">sigstore slack</a>, I'm always happy to help.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<h2 id="google-cloud-platform"><a class="header" href="#google-cloud-platform">Google Cloud Platform</a></h2>
<h3 id="install-the-google-cloud-sdk"><a class="header" href="#install-the-google-cloud-sdk">Install the Google Cloud SDK</a></h3>
<p>Follow the Google Cloud SDK <a href="https://cloud.google.com/sdk/">documentation</a> to install and configure the <code>gcloud</code> command line utility.</p>
<p>Verify the Google Cloud SDK version is 338.0.0 or higher:</p>
<pre><code class="language-bash">gcloud version
</code></pre>
<h3 id="set-a-default-compute-region-and-zone"><a class="header" href="#set-a-default-compute-region-and-zone">Set a Default Compute Region and Zone</a></h3>
<p>This tutorial assumes a default compute region and zone have been configured.</p>
<p>If you are using the <code>gcloud</code> command-line tool for the first time <code>init</code> is the easiest way to do this:</p>
<pre><code class="language-bash">gcloud init
</code></pre>
<p><code>gcloud init</code> will give you an opportunity to create a new project and set a zone. If you're going to copy and paste CLI commands then for ease of use name it <code>sigstore-the-hard-way-proj</code></p>
<p>Be sure to authorize gcloud to access the Cloud Platform with your Google user credentials:</p>
<pre><code class="language-bash">gcloud auth login
</code></pre>
<p>Next set a default compute region and compute zone:</p>
<pre><code class="language-bash">gcloud config set compute/region europe-west1
</code></pre>
<p>Set a default compute zone:</p>
<pre><code class="language-bash">gcloud config set compute/zone europe-west1-b
</code></pre>
<blockquote>
<p>üìù Use the <code>gcloud compute zones list</code> command to view additional regions and zones.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="provisioning-compute--network-resources"><a class="header" href="#provisioning-compute--network-resources">Provisioning Compute / Network Resources</a></h1>
<h2 id="network-resources"><a class="header" href="#network-resources">Network Resources</a></h2>
<p>We next need to create a network for our compute resources</p>
<pre><code class="language-bash">gcloud compute networks create sigstore-the-hard-way-proj --subnet-mode custom
</code></pre>
<blockquote>
<p>üìù if you recieve an <code>reason: UREQ_PROJECT_BILLING_NOT_FOUND</code> error. You need
to <a href="https://support.google.com/googleapi/answer/6158867?hl=en">enable billing on the API</a></p>
</blockquote>
<p>We can now create a subnet with an internal range</p>
<pre><code class="language-bash">gcloud compute networks subnets create sigstore \
    --network sigstore-the-hard-way-proj \
    --range 10.240.0.0/24
</code></pre>
<p>Create some firewall rules to allow tcp, udp and icmp protocols</p>
<pre><code class="language-bash">gcloud compute firewall-rules create sigstore-the-hard-way-proj-allow-internal \
    --allow tcp,udp,icmp \
    --network sigstore-the-hard-way-proj \
    --source-ranges 10.240.0.0/24
</code></pre>
<pre><code class="language-bash">gcloud compute firewall-rules create sigstore-the-hard-way-allow-external \
    --allow tcp:22,tcp:80,tcp:443,icmp \
    --network sigstore-the-hard-way-proj \
    --source-ranges 0.0.0.0/0
</code></pre>
<p>To verify the rules were created run the following command:</p>
<pre><code class="language-bash">gcloud compute firewall-rules list --filter=&quot;network:sigstore-the-hard-way-proj&quot;
</code></pre>
<p>You should see an output similar to the following:</p>
<pre><code class="language-bash">NAME                                       NETWORK                     DIRECTION  PRIORITY  ALLOW                       DENY  DISABLED
sigstore-the-hard-way-allow-external       sigstore-the-hard-way-proj  INGRESS    1000      tcp:22,tcp:80,tcp:443,icmp        False
sigstore-the-hard-way-proj-allow-internal  sigstore-the-hard-way-proj  INGRESS    1000      tcp,udp,icmp                      False
</code></pre>
<h2 id="compute-resources"><a class="header" href="#compute-resources">Compute Resources</a></h2>
<p>Now we need to create four compute nodes for each service.</p>
<pre><code class="language-bash">gcloud compute instances create sigstore-rekor \
    --async \
    --boot-disk-size 200GB \
    --image-family debian-10 \
    --image-project debian-cloud \
    --machine-type e2-small \
    --private-network-ip 10.240.0.10 \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet sigstore \
    --tags sigstore-the-hard-way-proj,sigstore-rekor
</code></pre>
<pre><code class="language-bash">gcloud compute instances create sigstore-fulcio \
    --async \
    --boot-disk-size 200GB \
    --image-family debian-10 \
    --image-project debian-cloud \
    --machine-type e2-small \
    --private-network-ip 10.240.0.11 \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet sigstore \
    --tags sigstore-the-hard-way-proj,sigstore-fulcio
</code></pre>
<pre><code class="language-bash">gcloud compute instances create sigstore-oauth2 \
    --async \
    --boot-disk-size 200GB \
    --image-family debian-10 \
    --image-project debian-cloud \
    --machine-type e2-small \
    --private-network-ip 10.240.0.12 \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet sigstore \
    --tags sigstore-the-hard-way-proj,sigstore-oauth2
</code></pre>
<pre><code class="language-bash">gcloud compute instances create sigstore-ctl \
    --async \
    --boot-disk-size 200GB \
    --image-family debian-10 \
    --image-project debian-cloud \
    --machine-type e2-small \
    --private-network-ip 10.240.0.13 \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet sigstore \
    --tags sigstore-the-hard-way-proj,sigstore-ctl
</code></pre>
<p>Verify all compute instances are in a <code>RUNNING</code> state.</p>
<pre><code class="language-bash">gcloud compute instances list --filter=&quot;tags.items=sigstore-the-hard-way-proj&quot;
</code></pre>
<p>The output should be as follows:</p>
<pre><code class="language-bash">NAME             ZONE            MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
sigstore-ctl     europe-west1-c  e2-small                   10.240.0.13  35.241.198.188  RUNNING
sigstore-fulcio  europe-west1-c  e2-small                   10.240.0.11  35.241.201.91   RUNNING
sigstore-oauth2  europe-west1-c  e2-small                   10.240.0.12  35.240.60.139   RUNNING
sigstore-rekor   europe-west1-c  e2-small                   10.240.0.10  35.233.82.12    RUNNING
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="domain-configuration"><a class="header" href="#domain-configuration">Domain configuration</a></h1>
<p>Now that are instances are running, lets grab the external IP's and set up domains.</p>
<blockquote>
<p>üìù A cheap temp domain can be grabbed from <a href="https://console.cloud.google.com/net-services/domains/">Google Cloud Domains</a>. Just type in random, nonsensical string
and you should easily be able to get a domain
for $1. There are also lots of other providers. Use whatever works for you.</p>
</blockquote>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Export a variable that will point to the domain you just bought. In this example we'll be using <code>example.com</code>:</p>
<pre><code class="language-bash">export DOMAIN=&quot;example.com&quot;
</code></pre>
<p>We'll be using this variable throughout the following code-snippets.</p>
<h3 id="rekorexamplecom"><a class="header" href="#rekorexamplecom">rekor.example.com</a></h3>
<p>Grab your external / public IP</p>
<pre><code class="language-bash">gcloud compute instances describe sigstore-rekor \
  --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
</code></pre>
<p>You now want to make an &quot;A Record&quot; to a subdomain or &quot;rekor&quot; and to your external IP from the above command</p>
<p>To create resource records on Google,</p>
<ol>
<li>Go to <a href="https://domains.google.com/">Google Domains</a></li>
<li>Click on your domain from the homepage</li>
<li>DNS &gt; Manage Custom Records</li>
</ol>
<p>If you're using GCP as the DNS provider this can be done as follows</p>
<pre><code class="language-bash">gcloud dns record-sets create rekor.$DOMAIN. \
  --rrdatas=$(gcloud compute instances describe sigstore-rekor --format='get(networkInterfaces[0].accessConfigs[0].natIP)') \
  --type=A --ttl=60 --zone=example-com
</code></pre>
<table><thead><tr><th>Type</th><th>Host</th><th>Value</th></tr></thead><tbody>
<tr><td>A Record</td><td>rekor</td><td>x.x.x.x</td></tr>
</tbody></table>
<h3 id="fulcioexamplecom"><a class="header" href="#fulcioexamplecom">fulcio.example.com</a></h3>
<p>Now repeat the same for fulcio, and dex</p>
<pre><code class="language-bash">gcloud compute instances describe sigstore-fulcio \
  --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
</code></pre>
<p>If you're using GCP as the DNS provider this can be done as follows</p>
<pre><code class="language-bash">gcloud dns record-sets create fulcio.$DOMAIN. \
  --rrdatas=$(gcloud compute instances describe sigstore-fulcio --format='get(networkInterfaces[0].accessConfigs[0].natIP)') \
  --type=A --ttl=60 --zone=example-com
</code></pre>
<table><thead><tr><th>Type</th><th>Host</th><th>Value</th></tr></thead><tbody>
<tr><td>A Record</td><td>fulcio</td><td>x.x.x.x</td></tr>
</tbody></table>
<h3 id="oauth2examplecom"><a class="header" href="#oauth2examplecom">oauth2.example.com</a></h3>
<pre><code class="language-bash">gcloud compute instances describe sigstore-oauth2 \
  --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
</code></pre>
<p>If you're using GCP as the DNS provider this can be done as follows</p>
<pre><code class="language-bash">gcloud dns record-sets create oauth2.$DOMAIN. \
  --rrdatas=$(gcloud compute instances describe sigstore-oauth2 --format='get(networkInterfaces[0].accessConfigs[0].natIP)') \
  --type=A --ttl=60 --zone=example-com
</code></pre>
<table><thead><tr><th>Type</th><th>Host</th><th>Value</th></tr></thead><tbody>
<tr><td>A Record</td><td>oauth2</td><td>x.x.x.x</td></tr>
</tbody></table>
<blockquote>
<p>üìù We do not need a domain for the certificate transparency log. This only
communicate over a private network to Fulcio.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rekor"><a class="header" href="#rekor">rekor</a></h1>
<p>Rekor is sigstores signature transparency log.</p>
<p>Rekor requires running instances of trillian's log server and signer, with a database backend. A few different databases
can be used by trillian, for this example we will use mariadb.</p>
<p>Let's start by logging in</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-rekor
</code></pre>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>We need a few dependencies installed</p>
<p>Update your system</p>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<p>Grab the following packages</p>
<pre><code class="language-bash">sudo apt-get install mariadb-server git redis-server haproxy certbot -y
</code></pre>
<blockquote>
<p>üìù redis-server is optional, but useful for a quick indexed search should you decide you need it. If you don't install it,
you need to start rekor with <code>--enable_retrieve_api=false</code></p>
</blockquote>
<h3 id="install-latest-golang-compiler"><a class="header" href="#install-latest-golang-compiler">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package is not yet 1.16)</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code>Welcome to the Go installer!
Downloading Go version go1.17.1 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile
go version
go version go1.17.1 linux/amd64
</code></pre>
<h3 id="install-rekor"><a class="header" href="#install-rekor">Install rekor</a></h3>
<p>We will work with the rekor repo (we grab the whole repo as we will need a some scripts)</p>
<pre><code class="language-bash">mkdir -p ~/go/src/github.com/sigstore &amp;&amp; cd &quot;$_&quot;
</code></pre>
<pre><code class="language-bash">git clone https://github.com/sigstore/rekor.git &amp;&amp; cd rekor/
</code></pre>
<p>And let's install both the server and the CLI</p>
<pre><code class="language-bash">go build -o rekor-cli ./cmd/rekor-cli
</code></pre>
<pre><code class="language-bash">sudo mv rekor-cli /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go build -o rekor-server ./cmd/rekor-server
</code></pre>
<pre><code class="language-bash">sudo mv rekor-server /usr/local/bin/
</code></pre>
<h3 id="database"><a class="header" href="#database">Database</a></h3>
<p>Trillian requires a database, let's first run <code>mysql_secure_installation</code> to
remove test accounts etc.</p>
<pre><code>sudo mysql_secure_installation

NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we'll need the current
password for the root user.  If you've just installed MariaDB, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] n
 ... skipping.

By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MariaDB comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...

All done!  If you've completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!
</code></pre>
<p>We can now build the database</p>
<p>Within the rekor repository is a <code>scripts/createdb.sh</code> script.</p>
<p>Edit this script and populate the root password <code>ROOTPASS</code> you set for the system
and then run the script (leave blank if not)</p>
<pre><code class="language-bash">cd scripts/
sudo ./createdb.sh
Creating test database and test user account
Loading table data..
</code></pre>
<h3 id="install-trillian-components"><a class="header" href="#install-trillian-components">Install trillian components</a></h3>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_server@v1.3.14-0.20210713114448-df474653733c
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/trillian_log_server /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_signer@v1.3.14-0.20210713114448-df474653733c
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/trillian_log_signer /usr/local/bin/
</code></pre>
<h3 id="run-trillian"><a class="header" href="#run-trillian">Run trillian</a></h3>
<p>The following are best run in two terminals, which are then left open (this
helps for debugging)</p>
<pre><code class="language-bash">trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
</code></pre>
<pre><code class="language-bash">trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
</code></pre>
<p>Alternatively, create bare minimal systemd services</p>
<pre><code class="language-bash">cat /etc/systemd/system/trillian_log_server.service
[Unit]
Description=trillian_log_server
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">cat /etc/systemd/system/trillian_log_signer.service
[Unit]
Description=trillian_log_signer
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Enable systemd services</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
</code></pre>
<pre><code class="language-bash">sudo systemctl enable trillian_log_server.service
Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_server.service ‚Üí /etc/systemd/system/trillian_log_server.service.
sudo systemctl start trillian_log_server.service
sudo systemctl status trillian_log_server.service
‚óè trillian_log_server.service - trillian_log_server
   Loaded: loaded (/etc/systemd/system/trillian_log_server.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:41:49 UTC; 8s ago
</code></pre>
<pre><code class="language-bash">sudo systemctl enable trillian_log_signer.service
Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_signer.service ‚Üí /etc/systemd/system/trillian_log_signer.service.
sudo systemctl start trillian_log_signer.service
sudo systemctl status trillian_log_signer.service
‚óè trillian_log_signer.service - trillian_log_signer
   Loaded: loaded (/etc/systemd/system/trillian_log_signer.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:42:05 UTC; 12s ago
</code></pre>
<h3 id="start-rekor"><a class="header" href="#start-rekor">Start rekor</a></h3>
<p>Start rekor</p>
<pre><code class="language-bash">rekor-server serve --rekor_server.address=0.0.0.0 --trillian_log_server.port=8091
</code></pre>
<p>Note: Rekor runs on port 3000 on all interfaces by default</p>
<p>Alternatively, you may create a bare minimal systemd service similar to trillian above</p>
<pre><code class="language-bash">cat /etc/systemd/system/rekor.service
[Unit]
Description=rekor
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/rekor-server serve --rekor_server.address=0.0.0.0 --trillian_log_server.port=8091
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable rekor.service
sudo systemctl start rekor.service
sudo systemctl status rekor.service
</code></pre>
<h3 id="lets-encrypt-tls--ha-proxy-config"><a class="header" href="#lets-encrypt-tls--ha-proxy-config">Let's encrypt (TLS) &amp; HA Proxy config</a></h3>
<p>Let's create a HAProxy config, set <code>DOMAIN</code> to your registered domain and your
private IP address.</p>
<pre><code class="language-bash">DOMAIN=&quot;rekor.example.com&quot;
IP=&quot;10.240.0.10&quot;
</code></pre>
<p>Let's now run certbot to obtain our TLS certs.</p>
<pre><code class="language-bash">sudo certbot certonly --standalone --preferred-challenges http \
      --http-01-address ${IP} --http-01-port 80 -d ${DOMAIN} \
      --non-interactive --agree-tos --email youremail@domain.com
</code></pre>
<p>Move the PEM chain into place</p>
<pre><code class="language-bash">sudo cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    | sudo tee &quot;/etc/ssl/private/${DOMAIN}.pem&quot; &gt; /dev/null
</code></pre>
<p>Now we need to change certbot configuration for automatic renewal</p>
<p>Prepare post renewal script</p>
<pre><code class="language-bash">cat /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
#!/bin/bash

DOMAIN=&quot;rekor.example.com&quot;

cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    &gt; &quot;/etc/ssl/private/${DOMAIN}.pem&quot;

systemctl reload haproxy.service
</code></pre>
<p>Make sure the script has executable flag set</p>
<pre><code class="language-bash">sudo chmod +x /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Replace port and address in the certbot's renewal configuration file for the domain (pass ACME request through the haproxy to certbot)</p>
<pre><code class="language-bash">ls -l /etc/letsencrypt/renewal/rekor.example.com.conf
</code></pre>
<pre><code>http01_port = 9080
http01_address = 127.0.0.1
</code></pre>
<p>Append new line</p>
<pre><code>post_hook = /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Prepare haproxy configuration</p>
<pre><code class="language-bash">cat &gt; haproxy.cfg &lt;&lt;EOF
defaults
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    log global
    mode http
    option httplog
    maxconn 3000
    log 127.0.0.1 local0

frontend haproxy
    #public IP address
    bind ${IP}:80
    bind ${IP}:443 ssl crt /etc/ssl/private/${DOMAIN}.pem

    # HTTPS redirect
    redirect scheme https code 301 if !{ ssl_fc }

    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend letsencrypt-backend if letsencrypt-acl

    default_backend sigstore_rekor

backend sigstore_rekor
    server sigstore_rekor_internal ${IP}:3000

backend letsencrypt-backend
    server certbot_internal 127.0.0.1:9080
EOF
</code></pre>
<p>Inspect the resulting <code>haproxy.cfg</code> and make sure everything looks correct.</p>
<p>If so, move it into place</p>
<pre><code class="language-bash">sudo mv haproxy.cfg /etc/haproxy/
</code></pre>
<p>Check syntax</p>
<pre><code class="language-bash">sudo /usr/sbin/haproxy -c -V -f /etc/haproxy/haproxy.cfg
</code></pre>
<h3 id="start-haproxy"><a class="header" href="#start-haproxy">Start HAProxy</a></h3>
<p>Let's now start HAProxy</p>
<pre><code class="language-bash">sudo systemctl enable haproxy.service

Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable haproxy
</code></pre>
<pre><code class="language-bash">sudo systemctl restart haproxy.service
sudo systemctl status haproxy.service
‚óè haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/lib/systemd/system/haproxy.service; enabled; vendor preset: enabled)
   Active: active (running) since Sun 2021-07-18 10:12:28 UTC; 58min ago
     Docs: man:haproxy(1)
           file:/usr/share/doc/haproxy/configuration.txt.gz
 Main PID: 439 (haproxy)
    Tasks: 2 (limit: 2322)
   Memory: 4.1M
   CGroup: /system.slice/haproxy.service
           ‚îú‚îÄ439 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
           ‚îî‚îÄ444 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid

Jul 18 10:12:27 sigstore-fulcio systemd[1]: Starting HAProxy Load Balancer...
Jul 18 10:12:28 sigstore-fulcio systemd[1]: Started HAProxy Load Balancer.
</code></pre>
<p>Test automatic renewal</p>
<pre><code class="language-bash">sudo certbot renew --dry-run
</code></pre>
<h3 id="test-rekor"><a class="header" href="#test-rekor">Test rekor</a></h3>
<p>Now we will test the operation of rekor. From the rekor repository (so we have
some test files) we can perform an inclusion by adding some signing materials</p>
<pre><code class="language-bash">rekor-cli upload --artifact tests/test_file.txt --public-key tests/test_public_key.key --signature tests/test_file.sig --rekor_server http://127.0.0.1:3000
</code></pre>
<p>Example:</p>
<pre><code>rekor-cli upload --artifact tests/test_file.txt --public-key tests/test_public_key.key --signature tests/test_file.sig --rekor_server http://127.0.0.1:3000
Created entry at index 0, available at: http://127.0.0.1:3000/api/v1/log/entries/b08416d417acdb0610d4a030d8f697f9d0a718024681a00fa0b9ba67072a38b5
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dex"><a class="header" href="#dex">Dex</a></h1>
<p>Dex is the solution used for handling OpenID connect sessions.</p>
<p>A user first connects to a dex instance where an OpenID session is invoked.</p>
<p>The user then authorises Fulcio to request the users email address as part of an
OpenID scope. This email address is then recored into the x509 signing
certificates</p>
<p>Connect to the compute instance</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-oauth2
</code></pre>
<h2 id="dependencies-1"><a class="header" href="#dependencies-1">Dependencies</a></h2>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<pre><code class="language-bash">sudo apt-get install haproxy make git gcc certbot -y
</code></pre>
<h3 id="install-latest-golang-compiler-1"><a class="header" href="#install-latest-golang-compiler-1">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package is not yet 1.16)</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code>Welcome to the Go installer!
Downloading Go version go1.17.1 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile
go version
go version go1.17.1 linux/amd64
</code></pre>
<h3 id="lets-encrypt-tls--ha-proxy-config-1"><a class="header" href="#lets-encrypt-tls--ha-proxy-config-1">Let's encrypt (TLS) &amp; HA Proxy config</a></h3>
<p>Let's create a HAProxy config, set <code>DOMAIN</code> to your registered domain and your
private <code>IP</code> address</p>
<pre><code class="language-bash">DOMAIN=&quot;oauth2.yourdomain.com&quot;
IP=&quot;10.240.0.12&quot;
</code></pre>
<p>Let's now run certbot to obtain our TLS certs.</p>
<pre><code class="language-bash">sudo certbot certonly --standalone --preferred-challenges http \
      --http-01-address ${IP} --http-01-port 80 -d ${DOMAIN} \
      --non-interactive --agree-tos --email youremail@domain.com
</code></pre>
<p>Move the PEM chain into place</p>
<pre><code class="language-bash">sudo cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    | sudo tee &quot;/etc/ssl/private/${DOMAIN}.pem&quot; &gt; /dev/null
</code></pre>
<p>Now we need to change certbot configuration for automatic renewal</p>
<p>Prepare post renewal script</p>
<pre><code class="language-bash">cat /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
#!/bin/bash

DOMAIN=&quot;oauth2.example.com&quot;

cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    &gt; &quot;/etc/ssl/private/${DOMAIN}.pem&quot;

systemctl reload haproxy.service
</code></pre>
<p>Make sure the script has executable flag set</p>
<pre><code class="language-bash">sudo chmod +x /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Replace port and address in the certbot's renewal configuration file for the domain (pass ACME request through the haproxy to certbot)</p>
<pre><code class="language-bash">ls -l /etc/letsencrypt/renewal/oauth2.example.com.conf
</code></pre>
<pre><code>http01_port = 9080
http01_address = 127.0.0.1
</code></pre>
<p>Append new line</p>
<pre><code>post_hook = /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Prepare haproxy configuration</p>
<pre><code class="language-bash">cat &gt; haproxy.cfg &lt;&lt;EOF
defaults
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    log global
    mode http
    option httplog
    maxconn 3000
    log 127.0.0.1 local0

frontend haproxy
    #public IP address
    bind ${IP}:80
    bind ${IP}:443 ssl crt /etc/ssl/private/${DOMAIN}.pem

    # HTTPS redirect
    redirect scheme https code 301 if !{ ssl_fc }

    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend letsencrypt-backend if letsencrypt-acl

    default_backend sigstore_dex

backend sigstore_dex
    server sigstore_oauth2_internal ${IP}:6000

backend letsencrypt-backend
    server certbot_internal 127.0.0.1:9080
EOF
</code></pre>
<p>Inspect the resulting <code>haproxy.cfg</code> and make sure everything looks correct.</p>
<p>If so, move it into place</p>
<pre><code class="language-bash">sudo mv haproxy.cfg /etc/haproxy/
</code></pre>
<p>Check syntax</p>
<pre><code class="language-bash">sudo /usr/sbin/haproxy -c -V -f /etc/haproxy/haproxy.cfg
</code></pre>
<h3 id="start-haproxy-1"><a class="header" href="#start-haproxy-1">Start HAProxy</a></h3>
<p>Let's now start HAProxy</p>
<pre><code class="language-bash">sudo systemctl enable haproxy.service

Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable haproxy
</code></pre>
<pre><code class="language-bash">sudo systemctl restart haproxy.service
sudo systemctl status haproxy.service
‚óè haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/lib/systemd/system/haproxy.service; enabled; vendor preset: enabled)
   Active: active (running) since Sun 2021-07-18 10:12:28 UTC; 58min ago
     Docs: man:haproxy(1)
           file:/usr/share/doc/haproxy/configuration.txt.gz
 Main PID: 439 (haproxy)
    Tasks: 2 (limit: 2322)
   Memory: 4.1M
   CGroup: /system.slice/haproxy.service
           ‚îú‚îÄ439 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
           ‚îî‚îÄ444 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid

Jul 18 10:12:27 sigstore-fulcio systemd[1]: Starting HAProxy Load Balancer...
Jul 18 10:12:28 sigstore-fulcio systemd[1]: Started HAProxy Load Balancer.
</code></pre>
<p>Test automatic renewal</p>
<pre><code class="language-bash">sudo certbot renew --dry-run
</code></pre>
<h3 id="install-dex"><a class="header" href="#install-dex">Install Dex</a></h3>
<pre><code class="language-bash">mkdir -p ~/go/src/github.com/dexidp/ &amp;&amp; cd &quot;$_&quot;
git clone https://github.com/dexidp/dex.git
</code></pre>
<pre><code class="language-bash">cd dex
make build
sudo mv bin/dex /usr/local/bin/
</code></pre>
<h3 id="obtain-google-oauth-credentials"><a class="header" href="#obtain-google-oauth-credentials">Obtain Google OAUTH credentials</a></h3>
<blockquote>
<p>üìù We re using Google here, you can do the same for github and microsoft too.
The placeholders are already within <code>config.yaml</code></p>
</blockquote>
<ol>
<li>
<p>Head to the <a href="https://console.cloud.google.com/apis/credentials">credentials page</a></p>
</li>
<li>
<p>Select 'CONFIGURE CONSENT SCREEN'</p>
<p>Select 'Internal'</p>
<p><img src="images/oauth-consent.png" alt="consent" /></p>
<p>NOTE: If you're not a Google Workspace user, the 'Internal' option will not be available. You can only make your app available to external (general audience) users only. In such a case, the 'External' User Type works fine as well.</p>
<p>Fill out the app registration details</p>
<p><img src="images/app-reg.png" alt="consent" /></p>
</li>
<li>
<p>Set scopes</p>
<p>Select 'ADD OR REMOVE SCOPES' and set the <code>userinfo.email</code> scope</p>
<p><img src="images/scopes.png" alt="scopes" /></p>
<p>Select &quot;SAVE AND CONTINUE&quot;</p>
<p>Select &quot;BACK TO DASHBOARD&quot; and select 'Credentials'</p>
</li>
<li>
<p>Create OAuth Client ID</p>
<p><img src="images/oauth-credentials.png" alt="credentials" /></p>
<p>Select &quot;OAuth client ID&quot;. Select &quot;Web Application&quot; and fill out the &quot;Authorized Redirect URIs&quot;</p>
<p>Select &quot;CREATE&quot;</p>
<p><img src="images/oauth-redirect.png" alt="redirect-uri" /></p>
</li>
<li>
<p>Note down tour Client ID and Secret and keep them safe (we will need them for dex)</p>
</li>
</ol>
<h3 id="configure-dex"><a class="header" href="#configure-dex">Configure Dex</a></h3>
<p>Set up the configuration file for dex.</p>
<p>Provide saved OIDC details as variables</p>
<pre><code class="language-bash">GOOGLE_CLIENT_ID=&quot;...&quot;
GOOGLE_CLIENT_SECRET=&quot;...&quot;
</code></pre>
<pre><code class="language-bash">cat &gt; dex-config.yaml &lt;&lt;EOF
issuer: https://${DOMAIN}/auth

storage:
  type: sqlite3
  config:
    file: /var/dex/dex.db
web:
  http: 0.0.0.0:5556
frontend:
  issuer: sigstore
  theme: light

# Configuration for telemetry
telemetry:
  http: 0.0.0.0:5558

# Options for controlling the logger.
logger:
  level: &quot;debug&quot;
  format: &quot;json&quot;

# Default values shown below
oauth2:
  responseTypes: [ &quot;code&quot; ]
  skipApprovalScreen: false
  alwaysShowLoginScreen: true

staticClients:
  - id: sigstore
    public: true
    name: 'sigstore'
redirectURI: https://${DOMAIN}/auth/callback

connectors:
- type: google
  id: google-sigstore-test
  name: Google
  config:
    clientID: $GOOGLE_CLIENT_ID
    clientSecret: $GOOGLE_CLIENT_SECRET
    redirectURI: https://${DOMAIN}/auth/callback

#- type: microsoft
#  id: microsoft-sigstore-test
#  name: Microsoft
#  config:
#     clientID: $MSFT_CLIENT_ID
#     clientSecret: $MSFT_CLIENT_SECRET
#     redirectURI: https://${DOMAIN}/auth/callback

#- type: github
#  id: github-sigstore-test
#  name: GitHub
#  config:
#     clientID: $GITHUB_CLIENT_ID
#     clientSecret: $GITHUB_CLIENT_SECRET
#     redirectURI: https://${DOMAIN}/auth/callback
EOF
</code></pre>
<p>Move configuration file</p>
<pre><code class="language-bash">sudo mkdir -p /var/dex/
sudo mkdir -p /etc/dex/
sudo mv dex-config.yaml /etc/dex/
</code></pre>
<h3 id="start-dex"><a class="header" href="#start-dex">Start dex</a></h3>
<pre><code class="language-bash">dex serve --web-http-addr=0.0.0.0:6000  dex-config.yaml
</code></pre>
<p>You may create a bare minimal systemd service for dex</p>
<pre><code class="language-bash">cat /etc/systemd/system/dex.service
[Unit]
Description=dex
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/dex serve --web-http-addr=0.0.0.0:6000 /etc/dex/dex-config.yaml
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable dex.service
sudo systemctl start dex.service
sudo systemctl status dex.service
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fulcio"><a class="header" href="#fulcio">Fulcio</a></h1>
<p>Now it's time to install the Fulcio WebPKI.</p>
<p>Fulcio requires a means to manage certificates. We have two options here,
we can use a SoftHSM or Google Certificate Authority service.</p>
<blockquote>
<p>üìù As of time of writing, plans are in place to support AWS Cloud HSM and
Azure Dedicated HSM.</p>
</blockquote>
<p>SSH into the Fulcio Compute instance</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-fulcio
</code></pre>
<h2 id="dependencies-2"><a class="header" href="#dependencies-2">Dependencies</a></h2>
<p>We need a few dependencies installed</p>
<p>Update your system</p>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<p>Grab the following packages</p>
<pre><code class="language-bash">sudo apt-get install git gcc haproxy softhsm certbot opensc -y
</code></pre>
<blockquote>
<p>üìù If you plan to use GCP Certificate Service, you can drop SoftHSM and opensc</p>
</blockquote>
<h3 id="install-latest-golang-compiler-2"><a class="header" href="#install-latest-golang-compiler-2">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package is not yet 1.16)</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code>Welcome to the Go installer!
Downloading Go version go1.17.1 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile
go version
go version go1.17.1 linux/amd64
</code></pre>
<h3 id="install-fulcio"><a class="header" href="#install-fulcio">Install Fulcio</a></h3>
<pre><code class="language-bash">go install github.com/sigstore/fulcio@v0.5.2
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/fulcio /usr/local/bin/
</code></pre>
<h3 id="lets-encrypt-tls--ha-proxy-config-2"><a class="header" href="#lets-encrypt-tls--ha-proxy-config-2">Let's encrypt (TLS) &amp; HA Proxy config</a></h3>
<p>Let's create a HAProxy config, set <code>DOMAIN</code> to your registered domain and your
private <code>IP</code> address</p>
<pre><code class="language-bash">DOMAIN=&quot;fulcio.yourdomain.com&quot;
IP=&quot;10.240.0.11&quot;
</code></pre>
<p>Let's now run certbot to obtain our TLS certs.</p>
<pre><code class="language-bash">sudo certbot certonly --standalone --preferred-challenges http \
      --http-01-address ${IP} --http-01-port 80 -d ${DOMAIN} \
      --non-interactive --agree-tos --email youremail@domain.com
</code></pre>
<p>Move the PEM chain into place</p>
<pre><code class="language-bash">sudo cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    | sudo tee &quot;/etc/ssl/private/${DOMAIN}.pem&quot; &gt; /dev/null
</code></pre>
<p>Now we need to change certbot configuration for automatic renewal</p>
<p>Prepare post renewal script</p>
<pre><code class="language-bash">cat /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
#!/bin/bash

DOMAIN=&quot;fulcio.example.com&quot;

cat &quot;/etc/letsencrypt/live/${DOMAIN}/fullchain.pem&quot; \
    &quot;/etc/letsencrypt/live/${DOMAIN}/privkey.pem&quot; \
    &gt; &quot;/etc/ssl/private/${DOMAIN}.pem&quot;

systemctl reload haproxy.service
</code></pre>
<p>Make sure the script has executable flag set</p>
<pre><code class="language-bash">sudo chmod +x /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Replace port and address in the certbot's renewal configuration file for the domain (pass ACME request through the haproxy to certbot)</p>
<pre><code class="language-bash">ls -l /etc/letsencrypt/renewal/fulcio.example.com.conf
</code></pre>
<pre><code>http01_port = 9080
http01_address = 127.0.0.1
</code></pre>
<p>Append new line</p>
<pre><code>post_hook = /etc/letsencrypt/renewal-hooks/post/haproxy-ssl-renew.sh
</code></pre>
<p>Prepare haproxy configuration</p>
<pre><code class="language-bash">cat &gt; haproxy.cfg &lt;&lt;EOF
defaults
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    log global
    mode http
    option httplog
    maxconn 3000
    log 127.0.0.1 local0

frontend haproxy
    #public IP address
    bind ${IP}:80
    bind ${IP}:443 ssl crt /etc/ssl/private/${DOMAIN}.pem

    # HTTPS redirect
    redirect scheme https code 301 if !{ ssl_fc }

    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend letsencrypt-backend if letsencrypt-acl

    default_backend sigstore_fulcio

backend sigstore_fulcio
    server sigstore_fulcio_internal 0.0.0.0:5000

backend letsencrypt-backend
    server certbot_internal 127.0.0.1:9080
EOF
</code></pre>
<p>Inspect the resulting <code>haproxy.cfg</code> and make sure everything looks correct.</p>
<p>If so, move it into place</p>
<pre><code class="language-bash">sudo mv haproxy.cfg /etc/haproxy/
</code></pre>
<p>Check syntax</p>
<pre><code class="language-bash">sudo /usr/sbin/haproxy -c -V -f /etc/haproxy/haproxy.cfg
</code></pre>
<h3 id="start-haproxy-2"><a class="header" href="#start-haproxy-2">Start HAProxy</a></h3>
<p>Let's now start HAProxy</p>
<pre><code class="language-bash">sudo systemctl enable haproxy.service

Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable haproxy
</code></pre>
<pre><code class="language-bash">sudo systemctl restart haproxy.service
sudo systemctl status haproxy.service
‚óè haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/lib/systemd/system/haproxy.service; enabled; vendor preset: enabled)
   Active: active (running) since Sun 2021-07-18 10:12:28 UTC; 58min ago
     Docs: man:haproxy(1)
           file:/usr/share/doc/haproxy/configuration.txt.gz
 Main PID: 439 (haproxy)
    Tasks: 2 (limit: 2322)
   Memory: 4.1M
   CGroup: /system.slice/haproxy.service
           ‚îú‚îÄ439 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
           ‚îî‚îÄ444 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid

Jul 18 10:12:27 sigstore-fulcio systemd[1]: Starting HAProxy Load Balancer...
Jul 18 10:12:28 sigstore-fulcio systemd[1]: Started HAProxy Load Balancer.
</code></pre>
<p>Test automatic renewal</p>
<pre><code class="language-bash">sudo certbot renew --dry-run
</code></pre>
<h1 id="file-ca-setup"><a class="header" href="#file-ca-setup">File CA setup</a></h1>
<p>First we need to generate some keys and a root CA</p>
<pre><code class="language-bash">openssl ecparam -genkey -name prime256v1 -noout -out unenc.key
openssl ec -in unenc.key -out file_ca_key.pem -des
openssl ec -in file_ca_key.pem -pubout -out file_ca_pub.pem
openssl req -new -x509 -days 365 -extensions v3_ca -key file_ca_key.pem -out fulcio-root.pem
rm unenc.key
</code></pre>
<p>Copy all of the above key artifacts into <code>$HOME/fulcio-config/config</code></p>
<blockquote>
<p><strong>Note</strong>
You will need the file_ca_pub.pem file for the TUF root of cosign, with the sign-container section towards the end</p>
</blockquote>
<h1 id="softhsm-installation"><a class="header" href="#softhsm-installation">SoftHSM Installation</a></h1>
<blockquote>
<p>By default SoftHSM stores tokens in <code>/var/lib/softhsm/tokens/</code> directory, which is defined
in <code>/etc/softhsm/softhsm2.conf</code> configuration file, below we will define a custom configuration for fulcio.</p>
</blockquote>
<pre><code class="language-bash">mkdir -p $HOME/fulcio-config/config
mkdir $HOME/fulcio-config/tokens
</code></pre>
<pre><code class="language-bash">cat &lt;&lt;EOF | tee $HOME/fulcio-config/config/softhsm2.cfg &gt; /dev/null
directories.tokendir = $HOME/fulcio-config/tokens
objectstore.backend = file
log.level = INFO
slots.removable = false
EOF
</code></pre>
<pre><code class="language-bash">export SOFTHSM2_CONF=&quot;$HOME/fulcio-config/config/softhsm2.cfg&quot;
</code></pre>
<pre><code class="language-bash">echo 'export SOFTHSM2_CONF=&quot;$HOME/fulcio-config/config/softhsm2.cfg&quot;' &gt;&gt; ~/.bash_profile
</code></pre>
<pre><code class="language-bash">softhsm2-util --init-token --slot 0 --label fulcio --pin 2324 --so-pin 2324
</code></pre>
<p>Tokens will now be generated in <code>fulcio-config\tokens</code></p>
<pre><code class="language-bash">ls -la $HOME/fulcio-config/tokens
</code></pre>
<p>For example:</p>
<pre><code class="language-bash">softhsm2-util --init-token --slot 0 --label fulcio
=== SO PIN (4-255 characters) ===
Please enter SO PIN: ****
Please reenter SO PIN: ****
=== User PIN (4-255 characters) ===
Please enter user PIN: ****
Please reenter user PIN: ******
ERROR: The entered PINs are not equal.
=== User PIN (4-255 characters) ===
Please enter user PIN: ****
Please reenter user PIN: ****
The token has been initialized and is reassigned to slot 1773686385
</code></pre>
<p>Lets create a SoftHSM config for Fulcio</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | tee $HOME/fulcio-config/config/crypto11.conf &gt; /dev/null
{
  &quot;Path&quot; : &quot;/usr/lib/softhsm/libsofthsm2.so&quot;,
  &quot;TokenLabel&quot;: &quot;fulcio&quot;,
  &quot;Pin&quot; : &quot;2324&quot;
}
EOF
</code></pre>
<blockquote>
<p><strong>Note</strong>
The Path may vary for different OS versions.</p>
</blockquote>
<p>Now let's create a private key within the HSM</p>
<pre><code class="language-bash">pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so --login --login-type user --keypairgen --id 1 --label PKCS11CA --key-type EC:secp384r1
</code></pre>
<p>For example:</p>
<pre><code class="language-bash">pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so --login --login-type user --keypairgen --id 1 --label PKCS11CA --key-type EC:secp384r1
Using slot 0 with a present token (0x69b84e71)
Logging in to &quot;fulcio&quot;.
Please enter User PIN:
Key pair generated:
Private Key Object; EC
label:      PKCS11CA
ID:         01
Usage:      decrypt, sign, unwrap, derive
Access:     sensitive, always sensitive, never extractable, local
Public Key Object; EC  EC_POINT 384 bits
EC_POINT:   046104b04911577ad1a655ba469b32ae63832d6c0d19482058af1822c2b42f54934da3613cd87171594a9b00ff1f0b298c75fa9383470ec46f0b4a35e73b54c34cf2ecc664ada2d0a818a5ac2390d952cb3b8d66ebea974a1bb2465f323cbebc50927d
EC_PARAMS:  06052b81040022
label:      PKCS11CA
ID:         01
Usage:      encrypt, verify, wrap, derive
Access:     local
</code></pre>
<p>Now its time to create a Root CA using our newly minted private key:</p>
<pre><code class="language-bash">cd $HOME/fulcio-config/
fulcio createca --org={ORG} --country={UK} --locality={TOWN} --province={PROVINCE} --postal-code={POST_CODE} --street-address={STREET} --hsm-caroot-id 1 --out fulcio-root.pem
</code></pre>
<p>An example</p>
<pre><code class="language-bash">cd $HOME/fulcio-config/
fulcio createca --org=acme --country=USA --locality=Anytown --province=AnyPlace --postal-code=ABCDEF --street-address=123 Main St --hsm-caroot-id 1 --out fulcio-root.pem
2021-10-01T18:09:16.284Z        INFO    app/createca.go:48      binding to PKCS11 HSM
2021-10-01T18:09:16.289Z        INFO    app/createca.go:68      finding slot for private key: PKCS11CA
2021-10-01T18:09:16.304Z        INFO    app/createca.go:108     Root CA:
-----BEGIN CERTIFICATE-----
MIICJDCCAaqgAwIBAgIIVUu5cbwBx8EwCgYIKoZIzj0EAwMwVjELMAkGA1UEBhMC
TFYxCzAJBgNVBAgTAkxWMQswCQYDVQQHEwJMVjENMAsGA1UECRMESG9tZTEPMA0G
A1UEERMGTFYxMDI2MQ0wCwYDVQQKEwRhY21lMB4XDTIxMTAwMTE4MDkxNloXDTMx
MTAwMTE4MDkxNlowVjELMAkGA1UEBhMCTFYxCzAJBgNVBAgTAkxWMQswCQYDVQQH
EwJMVjENMAsGA1UECRMESG9tZTEPMA0GA1UEERMGTFYxMDI2MQ0wCwYDVQQKEwRh
Y21lMHYwEAYHKoZIzj0CAQYFK4EEACIDYgAEk4wYXHkLhdDlUlASZc65GI+5VDv3
OqmFdOI7/TwnPfrqFBNCxTPp0qNh7//s55tRac5pkXV4Af+xWUETlRd6RqBKcjjX
PHMZ0f+J/pZui4pPmw3ItvVCqfmNvCtASksSo0UwQzAOBgNVHQ8BAf8EBAMCAQYw
EgYDVR0TAQH/BAgwBgEB/wIBATAdBgNVHQ4EFgQUOXQnhKM/yhGTICrrgO78QyVN
nUMwCgYIKoZIzj0EAwMDaAAwZQIwEd1VjWI+P3eXMwUOGXbWJMYzrpcLakwj0JPW
Bx6oFXBadm4jZoKQX1FfNXMWgu0mAjEA4nz6OBtF8YJGRS9bTnWfe4V/lwukRczk
OPl9CeCgaJqQRXlMSw8uf3nO0rYXTGCF
-----END CERTIFICATE-----

2021-10-01T18:09:16.324Z        INFO    app/createca.go:122     root CA created with PKCS11 ID: 1
2021-10-01T18:09:16.324Z        INFO    app/createca.go:138     root CA saved to file: fulcio-root.pem
</code></pre>
<p>Check Root CA key usage</p>
<pre><code class="language-bash">openssl x509 -in fulcio-root.pem -noout -ext extendedKeyUsage,keyUsage
X509v3 Key Usage: critical
    Certificate Sign, CRL Sign
</code></pre>
<p>Transfer the root certificate over to the certificate transparency log (or copy / paste into a text file for later).</p>
<pre><code class="language-bash">gcloud compute scp fulcio-root.pem &lt;google_account_name&gt;@sigstore-ctl:~/
</code></pre>
<h1 id="google-certificate-authority-service"><a class="header" href="#google-certificate-authority-service">Google Certificate Authority Service</a></h1>
<p>Navigate to the <a href="https://console.cloud.google.com/marketplace/product/google/privateca.googleapis.com">Certificate Authority Service API</a> and enable the service</p>
<p><img src="images/enable_gcp_ca.png" alt="Enable CA" /></p>
<p>On the Google Cloud Console page, go to Security &gt; Certificate Authority Service &gt; Create CA</p>
<ol>
<li>
<p>Set the CA type (DevOps)</p>
<p><img src="images/ca_type.png" alt="CA Type" /></p>
</li>
<li>
<p>Set the cert subject details</p>
<p><img src="images/subj_name.png" alt="Subject" /></p>
</li>
<li>
<p>Set the key and algorithm to Ecliptic Curve P384</p>
<p><img src="images/ecp384.png" alt="ecp384" /></p>
</li>
<li>
<p>Leave Configure Artifacts as it is</p>
<p><img src="images/rev.png" alt="rev" /></p>
</li>
<li>
<p>Label (don't need one)</p>
<p><img src="images/label.png" alt="label" /></p>
</li>
<li>
<p>Create the CA</p>
<p><img src="images/create.png" alt="Create CA" /></p>
</li>
<li>
<p>Note down the Root CA and Resource name</p>
<p><img src="images/view.png" alt="Overview A" /></p>
<p><img src="images/view_two.png" alt="Overview B" /></p>
</li>
</ol>
<h1 id="fulcio-config"><a class="header" href="#fulcio-config">Fulcio Config</a></h1>
<p>Set the DNS for the OAuth2 / Dex Server</p>
<pre><code class="language-bash">OAUTH2_DOMAIN=&quot;oauth2.example.com&quot;
</code></pre>
<pre><code class="language-bash">cat &gt; $HOME/fulcio-config/config.json &lt;&lt;EOF
{
  &quot;OIDCIssuers&quot;: {
    &quot;https://accounts.google.com&quot;: {
      &quot;IssuerURL&quot;: &quot;https://accounts.google.com&quot;,
      &quot;ClientID&quot;: &quot;sigstore&quot;,
      &quot;Type&quot;: &quot;email&quot;
    },
    &quot;https://${OAUTH2_DOMAIN}/auth&quot;: {
      &quot;IssuerURL&quot;: &quot;https://${OAUTH2_DOMAIN}/auth&quot;,
      &quot;ClientID&quot;: &quot;sigstore&quot;,
      &quot;Type&quot;: &quot;email&quot;
    },
    &quot;https://token.actions.githubusercontent.com&quot;: {
      &quot;IssuerURL&quot;: &quot;https://token.actions.githubusercontent.com&quot;,
      &quot;ClientID&quot;: &quot;sigstore&quot;,
      &quot;Type&quot;: &quot;github-workflow&quot;
    }
  }
}
EOF
</code></pre>
<p>Inspect <code>config.json</code> and if everything looks in order, copy it into place</p>
<pre><code class="language-bash">mv config.json $HOME/fulcio-config/
</code></pre>
<h1 id="start-fulcioca"><a class="header" href="#start-fulcioca">Start FulcioCA</a></h1>
<p>We now have two methods of starting Fulcio depending on your Certificate
Authority system choice.</p>
<p>In both cases you may create a bare minimal systemd service</p>
<pre><code class="language-bash">cat /etc/systemd/system/fulcio.service
[Unit]
Description=fulcio
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
Environment=SOFTHSM2_CONF=/etc/fulcio-config/config/softhsm2.cfg
ExecStart=/usr/local/bin/fulcio serve --config-path=/etc/fulcio-config/config.json ...
WorkingDirectory=/etc/fulcio-config
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable fulcio.service
sudo systemctl start fulcio.service
sudo systemctl status fulcio.service
</code></pre>
<h2 id="file-ca"><a class="header" href="#file-ca">File CA</a></h2>
<pre><code class="language-bash">fulcio serve --config-path=$HOME/fulcio-config/config.json --ca=fileca --fileca-cert=fulcio-config/fulcio-root.pem  --fileca-key=fulcio-config/file_ca_key.pem --fileca-key-passwd=p6ssw0rd --ct-log-url=http://sigstore-ctl:6105/sigstore --host=0.0.0.0 --port=5000
</code></pre>
<h2 id="softhsm"><a class="header" href="#softhsm">SoftHSM</a></h2>
<pre><code class="language-bash">fulcio serve --config-path=$HOME/fulcio-config/config.json --ca=pkcs11ca --hsm-caroot-id=1 --pkcs11-config-path=$HOME/fulcio-config/config/crypto11.conf --ct-log-url=http://sigstore-ctl:6105/sigstore --host=0.0.0.0 --port=5000
</code></pre>
<blockquote>
<p>üìù Don't worry that the Certificate Transparency Log is not up yet. We will
set this up next.</p>
</blockquote>
<h2 id="google-certificate-authority-service-1"><a class="header" href="#google-certificate-authority-service-1">Google Certificate Authority Service</a></h2>
<pre><code class="language-bash">fulcio serve --config-path=/etc/fulcio-config/config.json --ca googleca --gcp_private_ca_parent=${resource_name} --ct-log-url=http://sigstore-ctl:6105/sigstore --host=0.0.0.0 --port=5000
</code></pre>
<blockquote>
<p>üìù Your resource name is a long POSIX type path string, e.g. <code>projects/sigstore-the-hard-way-proj/locations/europe-west1/caPools/sigstore-the-hard-way/certificateAuthorities/xxxx</code></p>
</blockquote>
<p>For example</p>
<pre><code>fulcio serve --config-path=/etc/fulcio-config/config.json --ca googleca --gcp_private_ca_parent=projects/sigstore-the-hard-way-proj/locations/europe-west1/caPools/sigstore-the-hard-way/certificateAuthorities/xxxx --ctl-log-url=http://sigstore-ctl:6105/sigstore
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="certificate-transparency-log"><a class="header" href="#certificate-transparency-log">Certificate transparency log</a></h1>
<p>We will now install the Certificate transparency log (CTL).</p>
<p>CTL requires running instances of trillian's log server and signer</p>
<p>Let's start by logging in</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-ctl
</code></pre>
<h2 id="dependencies-3"><a class="header" href="#dependencies-3">Dependencies</a></h2>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<pre><code class="language-bash">sudo apt-get install mariadb-server git wget -y
</code></pre>
<h3 id="install-latest-golang-compiler-3"><a class="header" href="#install-latest-golang-compiler-3">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package is not yet 1.16)</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code>Welcome to the Go installer!
Downloading Go version go1.17.1 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile
go version
go version go1.17.1 linux/amd64
</code></pre>
<h3 id="database-1"><a class="header" href="#database-1">Database</a></h3>
<p>Trillian requires a databbase, let's first run <code>mysql_secure_installation</code></p>
<pre><code class="language-bash">sudo mysql_secure_installation

NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we'll need the current
password for the root user.  If you've just installed MariaDB, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] n
 ... skipping.

By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MariaDB comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...

All done!  If you've completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!
</code></pre>
<p>We can now import the database as we used for rekor</p>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/sigstore/rekor/main/scripts/createdb.sh
</code></pre>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/sigstore/rekor/main/scripts/storage.sql
</code></pre>
<pre><code class="language-bash">chmod +x createdb.sh
</code></pre>
<pre><code class="language-bash">sudo ./createdb.sh
</code></pre>
<p>E.g.</p>
<pre><code>sudo ./createdb.sh
Creating test database and test user account
Loading table data..
</code></pre>
<h3 id="install-trillian-components-1"><a class="header" href="#install-trillian-components-1">Install trillian components</a></h3>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_server@v1.3.14-0.20210713114448-df474653733c
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/trillian_log_server /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_signer@v1.3.14-0.20210713114448-df474653733c
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/trillian_log_signer /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/createtree@v1.3.14-0.20210713114448-df474653733c
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/createtree /usr/local/bin/
</code></pre>
<h3 id="run-trillian-1"><a class="header" href="#run-trillian-1">Run trillian</a></h3>
<p>The following is best run in two terminals which are then left open (this helps for debugging)</p>
<pre><code class="language-bash">trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
</code></pre>
<pre><code class="language-bash">trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
</code></pre>
<p>Alternatively, create bare minimal systemd services</p>
<pre><code class="language-bash">cat /etc/systemd/system/trillian_log_server.service
[Unit]
Description=trillian_log_server
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">cat /etc/systemd/system/trillian_log_signer.service
[Unit]
Description=trillian_log_signer
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Enable systemd services</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
</code></pre>
<pre><code class="language-bash">sudo systemctl enable trillian_log_server.service
Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_server.service ‚Üí /etc/systemd/system/trillian_log_server.service.
sudo systemctl start trillian_log_server.service
sudo systemctl status trillian_log_server.service
‚óè trillian_log_server.service - trillian_log_server
   Loaded: loaded (/etc/systemd/system/trillian_log_server.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:41:49 UTC; 8s ago
</code></pre>
<pre><code class="language-bash">sudo systemctl enable trillian_log_signer.service
Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_signer.service ‚Üí /etc/systemd/system/trillian_log_signer.service.
sudo systemctl start trillian_log_signer.service
sudo systemctl status trillian_log_signer.service
‚óè trillian_log_signer.service - trillian_log_signer
   Loaded: loaded (/etc/systemd/system/trillian_log_signer.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:42:05 UTC; 12s ago
</code></pre>
<h3 id="install-ctfe-server"><a class="header" href="#install-ctfe-server">Install CTFE server</a></h3>
<pre><code class="language-bash">go install github.com/google/certificate-transparency-go/trillian/ctfe/ct_server@latest
</code></pre>
<pre><code class="language-bash">sudo mv ~/go/bin/ct_server /usr/local/bin/
</code></pre>
<h3 id="create-a-private-key"><a class="header" href="#create-a-private-key">Create a private key</a></h3>
<blockquote>
<p><strong>Warning</strong>
The following section dumps out keys into the home directory. This is only recommended if you do not greatly care about the security of this machine
If you do care, place them into a more secure location and chmod to a secure level of file permissions.</p>
</blockquote>
<p>Create a key pair with the following command:</p>
<pre><code class="language-bash">openssl ecparam -genkey -name prime256v1 -noout -out unenc.key
openssl ec -in unenc.key -out privkey.pem -des
</code></pre>
<p>Extract the public key from the key-pair:</p>
<pre><code class="language-bash">openssl ec -in privkey.pem -pubout -out ctfe_public.pem
</code></pre>
<p>Feel free to remove the unencrypted key:</p>
<pre><code class="language-bash">rm unenc.key
</code></pre>
<blockquote>
<p><strong>Note</strong>
The private key needs a passphrase, remember it as you will need it for <code>your_passphrase</code> when we create the <code>ct.cfg</code> further down.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong>
You will need the ctfe_public.pem file for the TUF root of cosign, with the sign-container section towards the end</p>
</blockquote>
<h3 id="create-a-tree-id"><a class="header" href="#create-a-tree-id">Create a Tree ID</a></h3>
<blockquote>
<p><strong>Note</strong>
<code>trillian_log_server</code> needs to be running for this command to execute</p>
</blockquote>
<pre><code class="language-bash">LOG_ID=&quot;$(createtree --admin_server localhost:8091)&quot;
</code></pre>
<h3 id="set-up-the-config-file"><a class="header" href="#set-up-the-config-file">Set up the config file</a></h3>
<pre><code class="language-bash">cat &gt; ct.cfg &lt;&lt;EOF
config {
  log_id: ${LOG_ID}
  prefix: &quot;sigstore&quot;
  roots_pem_file: &quot;/etc/ctfe-config/fulcio-root.pem&quot;
  private_key: {
    [type.googleapis.com/keyspb.PEMKeyFile] {
       path: &quot;/etc/ctfe-config/privkey.pem&quot;
       password: &quot;your_passphrase&quot;
    }
  }
}
EOF
</code></pre>
<p>Afterwards, open the file again and change <code>&lt;your_passphrase&gt;</code> to the one you used
when generating the private key.</p>
<blockquote>
<p><strong>Note</strong>
<code>fulcio-root.pem</code> is the root ID certificate, we created in <a href="06-fulcio.html">06-fulcio</a>.</p>
</blockquote>
<pre><code class="language-bash">sudo mkdir -p /etc/ctfe-config/
sudo mv ct.cfg /etc/ctfe-config/
sudo mv fulcio-root.pem /etc/ctfe-config/
sudo mv privkey.pem /etc/ctfe-config/
</code></pre>
<h3 id="start-the-ct-log"><a class="header" href="#start-the-ct-log">Start the CT log</a></h3>
<pre><code class="language-bash">ct_server -logtostderr -log_config /etc/ctfe-config/ct.cfg -log_rpc_server localhost:8091 -http_endpoint 0.0.0.0:6105
</code></pre>
<blockquote>
<p>üìù The <code>-http_endpoint</code> flag uses the internal private IP. We don't need this facing externally
(for this tutorial at least)</p>
</blockquote>
<p>You may create a bare minimal systemd service</p>
<pre><code class="language-bash">cat /etc/systemd/system/ct_server.service
[Unit]
Description=ct_server
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/ct_server -logtostderr -log_config /etc/ctfe-config/ct.cfg -log_rpc_server localhost:8091 -http_endpoint 0.0.0.0:6105
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable ct_server.service
sudo systemctl start ct_server.service
sudo systemctl status ct_server.service
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configure-container-registry"><a class="header" href="#configure-container-registry">Configure Container Registry</a></h1>
<p>To switch things up, we will use Github Container registry (ghcr.io)
to push an image and a signature with cosign. You can however
using an OCI registry, <a href="https://github.com/sigstore/cosign#registry-support">see here</a>
for a list of those currently supported by cosign.</p>
<p>First, let's create an image. You can use the following <code>Dockerfile</code> or any existing image
you already have locally</p>
<pre><code class="language-bash">cat &gt; Dockerfile &lt;&lt;EOF
FROM alpine
CMD [&quot;echo&quot;, &quot;Hello Sigstore!&quot;]
EOF
</code></pre>
<pre><code class="language-bash">docker build -t sigstore-thw:latest .
</code></pre>
<h2 id="gchr-pat-code"><a class="header" href="#gchr-pat-code">gchr PAT code</a></h2>
<p>Create a PAT (Personal Access Token) for your account, by following
<a href="https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token">the relevant GitHub page</a></p>
<p>Once you have your PAT code, login to ghcr:</p>
<pre><code class="language-bash">export CR_PAT=&quot;YOUR_TOKEN&quot; ; echo -n &quot;$CR_PAT&quot; | docker login ghcr.io -u &lt;github_user&gt; --password-stdin
</code></pre>
<h2 id="tag-and-push-an-image"><a class="header" href="#tag-and-push-an-image">Tag and push an image</a></h2>
<p>Now we can tag and push our image:</p>
<pre><code class="language-bash">docker tag SOURCE_IMAGE_NAME:VERSION ghcr.io/TARGET_OWNER/TARGET_IMAGE_NAME:VERSION
</code></pre>
<p>Push re-tagged imaged to the container registry:</p>
<pre><code class="language-bash">docker push ghcr.io/OWNER/IMAGE_NAME:VERSION
</code></pre>
<p>Example:</p>
<pre><code class="language-bash">docker tag sigstore-thw:latest ghcr.io/lukehinds/sigstore-thw:latest
docker push ghcr.io/lukehinds/sigstore-thw:latest
The push refers to repository [ghcr.io/lukehinds/sigstore-thw]
cb381a32b229: Pushed
latest: digest: sha256:568999d4aedd444465c442617666359ddcd4dc117b22375983d2576c3847c9ba size: 528
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cosign"><a class="header" href="#cosign">Cosign</a></h1>
<p>We will now install cosign. It is assumed from now, that cosign will
be run on a machine local to you (such as your laptop or PC), and outside of the sigstore infrastructure.</p>
<h2 id="install-cosign"><a class="header" href="#install-cosign">Install cosign</a></h2>
<p>Head the <a href="https://github.com/sigstore/cosign/releases/tag/v1.2.1">releases page for cosign v1.0</a>
and download a release specific to your hardware (MacOS, Linux, Windows)</p>
<p>Also download the cosign public key, signature for your architecture.</p>
<ul>
<li><code>release-cosign.pub</code></li>
<li><code>cosign-$OS-$ARCH.sig</code></li>
</ul>
<p>Verify the signing.</p>
<h3 id="linux-binary"><a class="header" href="#linux-binary">Linux binary</a></h3>
<p>Download required files</p>
<pre><code class="language-bash">curl -fsSL --remote-name-all https://github.com/sigstore/cosign/releases/download/v1.2.1/{cosign-linux-amd64,release-cosign.pub,cosign-linux-amd64.sig}
</code></pre>
<p>Verify signature</p>
<pre><code class="language-bash">openssl dgst -sha256 -verify release-cosign.pub -signature &lt;(cat cosign-linux-amd64.sig | base64 -d) cosign-linux-amd64
Verified OK
</code></pre>
<p>Remove signature files</p>
<pre><code class="language-bash">rm cosign-linux-amd64.sig release-cosign.pub
</code></pre>
<p>Install</p>
<pre><code class="language-bash">chmod +x cosign-linux-amd64
sudo mv cosign-linux-amd64 /usr/local/bin/cosign
</code></pre>
<h3 id="macos-binary"><a class="header" href="#macos-binary">MacOS binary</a></h3>
<p>Download required files</p>
<pre><code class="language-bash">curl -fsSL --remote-name-all https://github.com/sigstore/cosign/releases/download/v1.2.1/{cosign-darwin-amd64,release-cosign.pub,cosign-darwin-amd64.sig}
</code></pre>
<p>Verify signature</p>
<pre><code class="language-bash">openssl dgst -sha256 -verify release-cosign.pub -signature &lt;(cat cosign-darwin-amd64.sig | base64 -D) cosign-darwin-amd64
Verified OK
</code></pre>
<p>Remove signature files</p>
<pre><code class="language-bash">rm cosign-darwin-amd64.sig release-cosign.pub
</code></pre>
<p>Install</p>
<pre><code class="language-bash">chmod +x cosign-darwin-amd64
sudo mv cosign-darwin-amd64 /usr/local/bin/cosign
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sign-container"><a class="header" href="#sign-container">Sign Container</a></h1>
<p>We are now ready to sign our container using our own sigstore infrastructure</p>
<p>But before we do that, we need to use our own TUF public key file, you might remember created this when deploying the certificate transparency server</p>
<p>Have this file locally and set it as an environment variable</p>
<pre><code class="language-bash">export SIGSTORE_CT_LOG_PUBLIC_KEY_FILE=&quot;/path/to/ctfe_public.pem&quot;
</code></pre>
<pre><code class="language-bash">COSIGN_EXPERIMENTAL=1 cosign sign --oidc-issuer &quot;https://oauth2.example.com/auth&quot; --fulcio-url &quot;https://fulcio.example.com&quot; --rekor-url &quot;https://rekor.example.com&quot; ghcr.io/&lt;github_user&gt;/sigstore-thw:latest
</code></pre>
<blockquote>
<p>:notebook: <code>COSIGN_EXPERIMENTAL</code> does as it says, you're trying out an experimental feature here.</p>
</blockquote>
<blockquote>
<p>üìù If you receive an <code>UNAUTHORIZED: authentication required</code> error. You need
to reauthenticate with your PAT in GitHub Container Registry again, refer to <a href="08-configure-registry.html">Configure registry</a></p>
</blockquote>
<p>An example run:</p>
<pre><code class="language-bash">COSIGN_EXPERIMENTAL=1 cosign sign -oidc-issuer https://oauth2.decodebytes.sh/auth -fulcio-url https://fulcio.decodebytes.sh -rekor-url https://rekor.decodebytes.sh ghcr.io/lukehinds/sigstore-thw:latest
Generating ephemeral keys...
Retrieving signed certificate...
Your browser will now be opened to:
https://oauth2.decodebytes.sh/auth/auth?access_type=online&amp;client_id=sigstore&amp;code_challenge=ZP91ElDffEaUAJxCTYpr_RfpvLHTx8a9WEuiDJiMQT0&amp;code_challenge_method=S256&amp;nonce=1vzuVUvfZ4caqLwqJlUsm0lJglb&amp;redirect_uri=http%3A%2F%2Flocalhost%3A5556%2Fauth%2Fcallback&amp;response_type=code&amp;scope=openid+email&amp;state=1vzuVUvXnKzS2hJnLzxkiDt0qOw
warning: uploading to the transparency log at https://rekor.decodebytes.sh for a private image, please confirm [Y/N]: Y
tlog entry created with index:  11
Pushing signature to: ghcr.io/lukehinds/sigstore-thw:latest:sha256-568999d4aedd444465c442617666359ddcd4dc117b22375983d2576c3847c9ba.sig
</code></pre>
<h2 id="verifying-the-signing"><a class="header" href="#verifying-the-signing">Verifying the signing</a></h2>
<p>We will now verify the signing, but before we do we need to tell cosign about our fulcio root.</p>
<p>Grab your <code>fulcio-root.pem</code> cerficate you generated on the fulcio server (and also copied to the certificate transparency server)</p>
<p>Set the following environment variable:</p>
<pre><code class="language-bash">export SIGSTORE_ROOT_FILE=&quot;$HOME/fulcio-root.pem&quot;
</code></pre>
<p>We can now verify</p>
<pre><code class="language-bash">COSIGN_EXPERIMENTAL=1 cosign verify -rekor-url https://rekor.example.com ghcr.io/&lt;github_user&gt;/sigstore-thw:latest
</code></pre>
<p>An example:</p>
<pre><code class="language-bash">COSIGN_EXPERIMENTAL=1 cosign verify -rekor-url https://rekor.decodebytes.sh ghcr.io/lukehinds/sigstore-thw:latest

Verification for ghcr.io/lukehinds/sigstore-thw:latest --
The following checks were performed on each of these signatures:
  - The cosign claims were validated
  - The claims were present in the transparency log
  - The signatures were integrated into the transparency log when the certificate was valid
  - Any certificates were verified against the Fulcio roots.
Certificate subject:  [lhinds@redhat.com]
{&quot;critical&quot;:{&quot;identity&quot;:{&quot;docker-reference&quot;:&quot;ghcr.io/lukehinds/sigstore-thw&quot;},&quot;image&quot;:{&quot;docker-manifest-digest&quot;:&quot;sha256:568999d4aedd444465c442617666359ddcd4dc117b22375983d2576c3847c9ba&quot;},&quot;type&quot;:&quot;cosign container image signature&quot;},&quot;optional&quot;:null}
</code></pre>
<h2 id="congrats"><a class="header" href="#congrats">Congrats</a></h2>
<p>If you got this far well done for completing the tutorial!</p>
<p><img src="images/glass.gif" alt="glass" /></p>
<h2 id="what-next"><a class="header" href="#what-next">What Next</a></h2>
<p>If you're not already part of the sigstore community, come and join us on our slack channel; <a href="https://join.slack.com/t/sigstore/shared_invite/zt-mhs55zh0-XmY3bcfWn4XEyMqUUutbUQ">Invite link</a>
and tell us abour your ideas!</p>
<p>If you want to improve this guide, please make an issue or better still a pull request!</p>
<p>Don't forget to delete your instances and not take on unwanted costs!</p>
<h2 id="having-issues-not-working"><a class="header" href="#having-issues-not-working">Having issues, not working?</a></h2>
<p>Raise an issue (best option, as others can learn) or message me on the <a href="https://join.slack.com/t/sigstore/shared_invite/zt-mhs55zh0-XmY3bcfWn4XEyMqUUutbUQ">sigstore slack</a>, I'm always happy to help.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributors"><a class="header" href="#contributors">Contributors</a></h1>
<p>Here is a list of the contributors who have helped improving sigstore the hardway. Big
shout-out to them!</p>
<ul>
<li>Nathan Smith (<a href="https://github.com/nsmith5">nsmith5</a>)</li>
<li>Viacheslav Vasilyev (<a href="https://github.com/avoidik">avoidik</a>)</li>
<li>Ayush Ambastha (<a href="https://github.com/AyushAmbastha">AyushAmbastha</a>)</li>
<li>Axel Simon (<a href="https://github.com/axelsimon">axelsimon</a>)</li>
<li>Steve Morgan (<a href="https://github.com/rebelopsio">rebelopsio</a>)</li>
<li><a href="https://github.com/mc-slava">mc-slava</a></li>
</ul>
<p>If you feel you're missing from this list, feel free to add yourself in a PR.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>

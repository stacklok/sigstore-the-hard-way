<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Certificate Transparency - sigstore the hard way</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="How to deploy sigstore from the ground up.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="01-prerequisites.html"><strong aria-hidden="true">1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="02-compute-resources.html"><strong aria-hidden="true">2.</strong> Compute Resources</a></li><li class="chapter-item expanded "><a href="03-domain-configuration.html"><strong aria-hidden="true">3.</strong> Domain Configuration</a></li><li class="chapter-item expanded "><a href="04-rekor.html"><strong aria-hidden="true">4.</strong> rekor</a></li><li class="chapter-item expanded "><a href="05-dex.html"><strong aria-hidden="true">5.</strong> Dex (oauth2)</a></li><li class="chapter-item expanded "><a href="06-fulcio.html"><strong aria-hidden="true">6.</strong> Fulcio</a></li><li class="chapter-item expanded "><a href="07-certifcate-transparency.html" class="active"><strong aria-hidden="true">7.</strong> Certificate Transparency</a></li><li class="chapter-item expanded "><a href="08-configure-registry.html"><strong aria-hidden="true">8.</strong> Configure OCI Registry</a></li><li class="chapter-item expanded "><a href="09-cosign.html"><strong aria-hidden="true">9.</strong> Setup Cosign</a></li><li class="chapter-item expanded "><a href="10-sign-container.html"><strong aria-hidden="true">10.</strong> Sign a Container</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="misc/contributors.html">Contributors</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">sigstore the hard way</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="certificate-transparency-log"><a class="header" href="#certificate-transparency-log">Certificate transparency log</a></h1>
<p>We will now install the Certificate transparency log (CTL).</p>
<p>CTL requires running instances of trillian's log server and signer</p>
<p>Let's start by logging in:</p>
<pre><code class="language-bash">gcloud compute ssh sigstore-ctl
</code></pre>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<pre><code class="language-bash">sudo apt-get update -y
</code></pre>
<p>If you want to save up some time, remove man-db first</p>
<pre><code class="language-bash">sudo apt-get remove -y --purge man-db
</code></pre>
<pre><code class="language-bash">sudo apt-get install mariadb-server git wget -y
</code></pre>
<h3 id="install-latest-golang-compiler"><a class="header" href="#install-latest-golang-compiler">Install latest golang compiler</a></h3>
<p>Download and run the golang installer (system package are often older than what Trillian requires):</p>
<pre><code class="language-bash">curl -O https://storage.googleapis.com/golang/getgo/installer_linux
</code></pre>
<pre><code class="language-bash">chmod +x installer_linux
</code></pre>
<pre><code class="language-bash">./installer_linux
</code></pre>
<p>e.g.</p>
<pre><code class="language-bash">Welcome to the Go installer!
Downloading Go version go1.20.4 to /home/luke/.go
This may take a bit of time...
Downloaded!
Setting up GOPATH
GOPATH has been set up!

One more thing! Run `source /home/$USER/.bash_profile` to persist the
new environment variables to your current session, or open a
new shell prompt.
</code></pre>
<p>As suggested run</p>
<pre><code class="language-bash">source /home/$USER/.bash_profile
go version
go version go1.20.4 linux/amd64
</code></pre>
<h3 id="database"><a class="header" href="#database">Database</a></h3>
<p>Trillian requires a database, let's first run <code>mysql_secure_installation</code></p>
<pre><code class="language-bash">sudo mysql_secure_installation
</code></pre>
<p>The script is interactive. The following snippet captures the answers to
the script's prompts:</p>
<pre><code class="language-bash">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we'll need the current
password for the root user.  If you've just installed MariaDB, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] n
 ... skipping.

By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MariaDB comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...

All done!  If you've completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!
</code></pre>
<p>We can now import the database as we used for rekor</p>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/sigstore/rekor/main/scripts/createdb.sh
</code></pre>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/sigstore/rekor/main/scripts/storage.sql
</code></pre>
<pre><code class="language-bash">chmod +x createdb.sh
</code></pre>
<pre><code class="language-bash">sudo ./createdb.sh
</code></pre>
<p>E.g.</p>
<pre><code>sudo ./createdb.sh
Creating test database and test user account
Loading table data..
</code></pre>
<h3 id="install-trillian-components"><a class="header" href="#install-trillian-components">Install trillian components</a></h3>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_server@v1.5.1
</code></pre>
<pre><code class="language-bash">sudo cp ~/go/bin/trillian_log_server /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/trillian_log_signer@v1.5.1
</code></pre>
<pre><code class="language-bash">sudo cp ~/go/bin/trillian_log_signer /usr/local/bin/
</code></pre>
<pre><code class="language-bash">go install github.com/google/trillian/cmd/createtree@v1.5.1
</code></pre>
<pre><code class="language-bash">sudo cp ~/go/bin/createtree /usr/local/bin/
</code></pre>
<h3 id="run-trillian"><a class="header" href="#run-trillian">Run trillian</a></h3>
<p>The following is best run in two terminals which are then left open (this helps for debugging)</p>
<pre><code class="language-bash">trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
</code></pre>
<pre><code class="language-bash">trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
</code></pre>
<p>Alternatively, create bare minimal systemd services</p>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt; EOF &gt; /etc/systemd/system/trillian_log_server.service
[Unit]
Description=trillian_log_server
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_server -http_endpoint=localhost:8090 -rpc_endpoint=localhost:8091 --logtostderr ...
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt; EOF &gt; /etc/systemd/system/trillian_log_signer.service
[Unit]
Description=trillian_log_signer
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/trillian_log_signer --logtostderr --force_master --http_endpoint=localhost:8190 -rpc_endpoint=localhost:8191  --batch_size=1000 --sequencer_guard_window=0 --sequencer_interval=200ms
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<p>Enable systemd services</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable trillian_log_server.service
sudo systemctl start trillian_log_server.service
sudo systemctl status trillian_log_server.service
sudo systemctl enable trillian_log_signer.service
sudo systemctl start trillian_log_signer.service
sudo systemctl status trillian_log_signer.service
</code></pre>
<pre><code class="language-bash">Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_server.service → /etc/systemd/system/trillian_log_server.service.
● trillian_log_server.service - trillian_log_server
   Loaded: loaded (/etc/systemd/system/trillian_log_server.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:41:49 UTC; 8s ago
Created symlink /etc/systemd/system/multi-user.target.wants/trillian_log_signer.service → /etc/systemd/system/trillian_log_signer.service.
● trillian_log_signer.service - trillian_log_signer
   Loaded: loaded (/etc/systemd/system/trillian_log_signer.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2021-09-30 17:42:05 UTC; 12s ago
</code></pre>
<h3 id="install-ctfe-server"><a class="header" href="#install-ctfe-server">Install CTFE server</a></h3>
<pre><code class="language-bash">go install github.com/google/certificate-transparency-go/trillian/ctfe/ct_server@latest
</code></pre>
<pre><code class="language-bash">sudo cp ~/go/bin/ct_server /usr/local/bin/
</code></pre>
<h3 id="create-a-private-key"><a class="header" href="#create-a-private-key">Create a private key</a></h3>
<blockquote>
<p><strong>Warning</strong>
The following section dumps out keys into the home directory. This is only recommended if you do not greatly care about the security of this machine
If you do care, place them into a more secure location and chmod to a secure level of file permissions.</p>
</blockquote>
<p>Create a key pair with the following command:</p>
<pre><code class="language-bash">openssl ecparam -genkey -name prime256v1 -noout -out unenc.key
openssl ec -in unenc.key -out privkey.pem -des3
</code></pre>
<p>Extract the public key from the key-pair:</p>
<pre><code class="language-bash">openssl ec -in privkey.pem -pubout -out ctfe_public.pem
</code></pre>
<p>Feel free to remove the unencrypted key:</p>
<pre><code class="language-bash">rm unenc.key
</code></pre>
<blockquote>
<p><strong>Note</strong>
The private key needs a passphrase, remember it as you will need it for <code>your_passphrase</code> when we create the <code>ct.cfg</code> further down.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong>
You will need the ctfe_public.pem file for the TUF root of cosign, with the sign-container section towards the end</p>
</blockquote>
<h3 id="create-a-tree-id"><a class="header" href="#create-a-tree-id">Create a Tree ID</a></h3>
<blockquote>
<p><strong>Note</strong>
<code>trillian_log_server</code> needs to be running for this command to execute</p>
</blockquote>
<pre><code class="language-bash">LOG_ID=&quot;$(createtree --admin_server localhost:8091)&quot;
</code></pre>
<h3 id="set-up-the-config-file"><a class="header" href="#set-up-the-config-file">Set up the config file</a></h3>
<pre><code class="language-bash">cat &gt; ct.cfg &lt;&lt;EOF
config {
  log_id: ${LOG_ID}
  prefix: &quot;sigstore&quot;
  roots_pem_file: &quot;/etc/ctfe-config/fulcio-root.pem&quot;
  private_key: {
    [type.googleapis.com/keyspb.PEMKeyFile] {
       path: &quot;/etc/ctfe-config/privkey.pem&quot;
       password: &quot;your_passphrase&quot;
    }
  }
}
EOF
</code></pre>
<p>Afterwards, open the file again and change <code>&lt;your_passphrase&gt;</code> to the one you used
when generating the private key.</p>
<blockquote>
<p><strong>Note</strong>
<code>fulcio-root.pem</code> is the root ID certificate, we created in <a href="06-fulcio.html">06-fulcio</a>.</p>
</blockquote>
<pre><code class="language-bash">sudo mkdir -p /etc/ctfe-config/
sudo cp ct.cfg /etc/ctfe-config/
sudo cp fulcio-root.pem /etc/ctfe-config/
sudo cp privkey.pem /etc/ctfe-config/
</code></pre>
<h3 id="start-the-ct-log"><a class="header" href="#start-the-ct-log">Start the CT log</a></h3>
<pre><code class="language-bash">ct_server -logtostderr -log_config /etc/ctfe-config/ct.cfg -log_rpc_server localhost:8091 -http_endpoint 0.0.0.0:6105
</code></pre>
<blockquote>
<p>📝 The <code>-http_endpoint</code> flag uses the internal private IP. We don't need this facing externally
(for this tutorial at least)</p>
</blockquote>
<p>You may create a bare minimal systemd service</p>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt; EOF &gt; /etc/systemd/system/ct_server.service
[Unit]
Description=ct_server
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
ExecStart=/usr/local/bin/ct_server -logtostderr -log_config /etc/ctfe-config/ct.cfg -log_rpc_server localhost:8091 -http_endpoint 0.0.0.0:6105
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable ct_server.service
sudo systemctl start ct_server.service
sudo systemctl status ct_server.service
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="06-fulcio.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="08-configure-registry.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="06-fulcio.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="08-configure-registry.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
